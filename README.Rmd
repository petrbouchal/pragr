---
output: github_document
---


<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# pragr: use Prague geodata in R 

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/petrbouchal/pragr.svg?branch=master)](https://travis-ci.org/petrbouchal/pragr)
<!-- badges: end -->

ðŸ“¦ `pragr` makes Prague raster geodata accessible for use in R via ðŸ“¦ `ggplot2`. 

## Installation

You can install the current version of pragr from GitHub with:

``` r
remotes::install_github("petrbouchal/pragr")
```

## What it does

Currently, the ðŸ“¦ enables you to do two things:

1) Add raster tiles from the Prague geoportal to a `ggplot2` object (`prg_tile()`)
2) Add other raster layer to a `ggplot2` object (`prg_basemap()`)

The basic logic of these two functions is that given a simple feature dataset, they provide the tiles or image to create the base map for those coordinates.

It relies on the REST API of ArcGis map/image services that power the geoportal. 

The approach draws heavily on code provided by [@yutannihilation](https://github.com/yutannihilation) in her [blog post](https://yutani.rbind.io/post/2018-06-09-plot-osm-tiles/) on using OpenStreetMap tiles in ðŸ“¦ `ggplot2`.

The approach should be generalisable to other ArcGis-driven servers with the same REST API, though the package as it now is assumes a projected CRS measured in meters, specifically the Krovak crs (EPSG 5514).

# Usage

```{r setup}
library(pragr)
library(dplyr)
library(sf)
library(ggplot2)
```

```{r load-data}
praha1 <- CzechData::load_RUIAN_settlement(prg_kod, "MOMC_P", WGS84 = F) %>% 
  filter(nazev == 'Praha 1')
```

```{r example-tiles}
ggplot() +
  prg_tile(data = praha1, zoom = 10, alpha = .7, buffer = 200,
           tile_service = 'orto') + 
  geom_sf(data = praha1, fill = alpha("red", 0.6), colour = NA) +
  theme_void()
```

```{r example-base}
ggplot() +
  prg_basemap(data = praha1, alpha = .8, buffer = 200,
              image_service = 'archiv', layer = 6) + 
  geom_sf(data = praha1, fill = alpha("red", 0.6), colour = NA) +
  theme_void()
```

# What's in a name?

The name of the package refers to [Karel Prager](https://en.wikipedia.org/wiki/Karel_Prager), a renowned Czech modernist architect. Among other things, he designed - and for a long time worked in - the office buildings in which the Institute for Planning and Development, Prague's public urban planning body, is housed today.

The institute's excellent data team develops and maintains the data and software infrastructure for Prague's geographical data on which this package - and much of Prague's planning, government and business - relies.

Prag is of course how the city was once called by its many German-speaking inhabitants.

# Data sources:

Most map/image services are accessible via <http://www.geoportalpraha.cz/cs/clanek/22/mapove-sluzby>

A more technical route to lists of services is via

- <https://mpp.praha.eu/arcgis/rest/services/>
- <https://tiles.arcgis.com/tiles/SBTXIEUGWbqzUecw/arcgis/rest/services>
- <http://mpp.iprpraha.cz/arcgis/rest/services/>

For some of the services, shortcut notation is implemented for use in the tile/basemap functions.

## Note on geodata about Prague



# See also:

- [CzechData](https://github.com/JanCaha/CzechData)

# TODO

Common

- [ ] improve temp file saving so that conflicts are minimised
- [ ] implement cache expiry (do not redownload before N days)
- [ ] generalise image caching logic
- [ ] merge and reorganise service spec list 
- [ ] expose list of all services via a dedicated function

`prg_basemap`

- [ ] add `verbose` parameter
- [ ] rewrite to use JSON spec (sizing, image format)
- [ ] allow 'max' as a value of the size parameter
- [ ] implement url option for service parameter
- [ ] make prg_basemap resilient to JPEGs
- [ ] check URL paramteres in base
- [x] test alpha logic in basemap
- [ ] implement automatic choice/choice cascade of format for base

`prg_tile`

- [ ] add `verbose` parameter
- [x] implement alpha in prg_tile
- [ ] check URL parameters in tile
- [ ] implement automatic zooming for tiles
- [ ] implement automatic choice/choice cascade of format for tile

Minor enhancements

- [ ] reexport CzechData fns + data relevant to Prague
- [ ] create CzechData wrappers for Prague (settlement, cadastre, registers/conversion tab les)
- [ ] expose precise 5514 CRS
- [ ] expose/reexport Prague codes
- [ ] expose Prague bbox
- [ ] Prague-shaped favicon/hex icon?

